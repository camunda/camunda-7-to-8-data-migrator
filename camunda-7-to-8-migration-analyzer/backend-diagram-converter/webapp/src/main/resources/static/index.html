<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>BPMN Diagram Converter</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">

</head>
<body>
<div class="container-fluid">
    <h1>BPMN Diagram Converter</h1>
    <div class="alert alert-primary" role="alert">
        <h6>Legal disclaimer</h6>
        <p class="small m-0">Each user retains the intellectual property rights it has created prior to accessing the
            BPMN Diagram
            Converter in connection to process models, studies or other materials of its own, uploaded on the BPMN
            Diagram Converter.</p>
        <p class="small m-0">The uploaded data in its complete context will not be saved or processed for other purposes
            than converting your process diagram.</p>
        <p class="small m-0">Technical problems that might occur will be sent to the administrator. The contained
            information will provide no insights on the full document.</p>
        <p class="small m-0">Through conversion, the behavior of your process diagram might change. Please review and
            test any converted diagram.</p>
    </div>
    <div class="row">
        <div class="mb-3" id="file-select">
            <label for="formFile" class="form-label">Camunda 7 BPMN files</label>
            <input class="form-control" type="file" id="formFile" multiple>
        </div>
        <div class="mb-3">
            <input class="form-check-input" type="checkbox" id="appendDocumentation">
            <label for="appendDocumentation"
                   class="form-check-label">Append
                messages to documentation</label>
        </div>
        <div class="mb-3">
            <button type="button" class="btn btn-primary" id="check">Check</button>
            <button type="button" class="btn btn-primary" id="convert">Convert and download</button>
        </div>
    </div>
    <div class="row">
        <div class="mb-3 text-bg-dark rounded">

        </div>
    </div>
    <div class="accordion" id="accordionExample" hidden>

        <div class="accordion-item">
            <h2 class="accordion-header" id="headingTwo">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                    Arranged results
                </button>
            </h2>
            <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo"
                 data-bs-parent="#accordionExample">
                <div class="accordion-body" id="arrangedResults">

                </div>
            </div>
        </div>
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingOne">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne"
                        aria-expanded="true" aria-controls="collapseOne">
                    Raw results
                </button>
            </h2>
            <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne"
                 data-bs-parent="#accordionExample">
                <div class="accordion-body">
                    <div class="text-bg-dark rounded">
                        <pre id="checkContainer"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8"
        crossorigin="anonymous"></script>
<script>
    const check = document.getElementById("check");
    const convert = document.getElementById("convert");

    const fileUpload = document.getElementById("formFile");
    const appendDocumentation = document.getElementById("appendDocumentation");

    const checkContainer = document.getElementById("checkContainer");
    const resultArea = document.getElementById("accordionExample");
    const arrangedResultsArea = document.getElementById("arrangedResults");

    const severityClasses = {
        "WARNING": "text-bg-danger",
        "INFO": "text-bg-info",
        "TASK": "text-bg-secondary"
    }


    const el = (tagName, attributes, children) => {
        const element = document.createElement(tagName);
        Object.keys(attributes).forEach(key => element[key] = attributes[key]);
        element.append(...children);
        return element;
    };

    const createFormattedResult = result => {
        if (result.messages.length) {
            return el("div", {className: "card m-3"}, [
                el("div", {className: "card-header"}, [result.elementType + " ", el("code", {}, result.elementId), ` ${result.elementName || ""}`]),
                createFormattedMessages(result.messages)
            ]);
        }
    };

    const createFormattedMessages = messages => {
        return el("ul", {className: "list-group list-group-flush"}, messages.map(createFormattedMessage));
    };

    const createFormattedMessage = message => {
        return el("li", {className: `list-group-item ${severityClasses[message.severity]}`}, `${message.severity}: ${message.message}`);
    };

    const createFormData = async () => {
        const formData = new FormData();
        if (fileUpload.files.length === 0) {
            alert("Please select a .bpmn file");
            return null;
        }
        for (let i = 0; i < fileUpload.files.length; i++) {
            formData.append("files", fileUpload.files[i], fileUpload.files[i].name)
        }
        formData.append("appendDocumentation", appendDocumentation.checked)
        return formData;
    }
    const createFormattedResultWrapper = files => {
        arrangedResultsArea.append(...files.map(createFormattedResultForFile));
    }

    const createFormattedResultForFile = file => {
        return el("div", {className: "card mb-3"}, [
            el("div", {className: "card-header"}, [file.filename]),
            el("ul", {className: "list-group list-group-flush"}, file.results.map(createFormattedResult).filter(e => e !== undefined))
        ]);
    }


    check.addEventListener("click", async () => {
        const formData = await createFormData();
        if (!formData) {
            return;
        }
        fetch("/check", {
            body: formData,
            method: "POST"
        }).then(response => {
            response.json().then(json => {
                checkContainer.innerHTML = JSON.stringify(json, null, 2);
                arrangedResultsArea.innerHTML = "";
                createFormattedResultWrapper(json);
                resultArea.hidden = false;
            })
        });
    });

    convert.addEventListener("click", async () => {
        const formData = await createFormData();
        if (!formData) {
            return;
        }
        fetch("/convert", {
            body: formData,
            method: "POST"
        }).then(response => {
            const contentDisposition = response.headers.get("Content-Disposition");
            const targetFileName = contentDisposition.substring(contentDisposition.indexOf("\"") + 1, contentDisposition.lastIndexOf("\""));
            response.blob().then(data => {
                const a = document.createElement("a");
                a.href = window.URL.createObjectURL(data);
                a.download = targetFileName;
                a.click();
            })
        });
    });
</script>
</body>
</html>