name: CI
on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: "0 5 * * 1-5"

jobs:
  e2e-cockpit-plugin:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: Import secrets
        id: secrets
        uses: hashicorp/vault-action@4c06c5ccf5c0761b6029f56cfb1dcf5565918a3b # v3.4.0
        with:
          url: ${{ secrets.VAULT_ADDR }}
          method: approle
          roleId: ${{ secrets.VAULT_ROLE_ID }}
          secretId: ${{ secrets.VAULT_SECRET_ID }}
          secrets: |
            secret/data/products/cambpm/ci/nexus NEXUS_APP_CAMUNDA_COM_USR;
            secret/data/products/cambpm/ci/nexus NEXUS_APP_CAMUNDA_COM_PSW;

      - name: Setup Maven
        uses: ./.github/actions/setup-maven
        with:
          vault-address: ${{ secrets.VAULT_ADDR }}
          vault-role-id: ${{ secrets.VAULT_ROLE_ID }}
          vault-secret-id: ${{ secrets.VAULT_SECRET_ID }}

      - name: Build Cockpit Plugin
        run: mvn clean install -DskipTests --batch-mode

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: qa/e2e-tests/package-lock.json

      - name: Install E2E test dependencies
        working-directory: qa/e2e-tests
        run: npm ci

      - name: Install Playwright browsers
        working-directory: qa/e2e-tests
        run: npx playwright install --with-deps chromium

      - name: Run E2E tests
        working-directory: qa/e2e-tests
        run: npm test
        env:
          CI: true

      - name: Upload test results
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: playwright-report
          path: qa/e2e-tests/playwright-report/
          retention-days: 7

      - name: Upload screenshots
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: e2e-screenshots
          path: qa/e2e-tests/test-results/
          retention-days: 7

      - name: Upload Cockpit Plugin JAR
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: data-migrator-cockpit-plugin
          path: plugins/cockpit/target/camunda-7-to-8-data-migrator-cockpit-plugin-0.2.0-SNAPSHOT.jar
          retention-days: 7

  # Rerun failed jobs running on self-hosted runners in case of network issues or node preemption
  rerun-failed-jobs:
    needs:
      - e2e-cockpit-plugin
    if: failure() && fromJSON(github.run_attempt) < 3
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Retrigger job
        uses: camunda/infra-global-github-actions/rerun-failed-run@main
        with:
          error-messages: |
            The runner has received a shutdown signal
            Could not transfer artifact
            ContainerFetchException: Can't get Docker image: RemoteDockerImage
          run-id: ${{ github.run_id }}
          repository: ${{ github.repository }}
          vault-addr: ${{ secrets.VAULT_ADDR }}
          vault-role-id: ${{ secrets.VAULT_ROLE_ID }}
          vault-secret-id: ${{ secrets.VAULT_SECRET_ID }}
