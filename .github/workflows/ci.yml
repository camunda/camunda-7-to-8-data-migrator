name: CI
on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: "0 5 * * 1-5"

jobs:
  distro-h2:
    runs-on: ubuntu-latest
    timeout-minutes: 70
    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6

      - name: Import secrets
        id: secrets
        uses: hashicorp/vault-action@4c06c5ccf5c0761b6029f56cfb1dcf5565918a3b # v3.4.0
        with:
          url: ${{ secrets.VAULT_ADDR }}
          method: approle
          roleId: ${{ secrets.VAULT_ROLE_ID }}
          secretId: ${{ secrets.VAULT_SECRET_ID }}
          secrets: |
            secret/data/products/cambpm/ci/nexus NEXUS_APP_CAMUNDA_COM_USR;
            secret/data/products/cambpm/ci/nexus NEXUS_APP_CAMUNDA_COM_PSW;

      - name: Setup Maven
        uses: ./.github/actions/setup-maven
        with:
          vault-address: ${{ secrets.VAULT_ADDR }}
          vault-role-id: ${{ secrets.VAULT_ROLE_ID }}
          vault-secret-id: ${{ secrets.VAULT_SECRET_ID }}

      - name: Build and run default tests
        run: mvn clean install --batch-mode

      - name: Collect distro
        id: distro
        if: github.ref == 'refs/heads/main'
        run: |
          ARTIFACT_DIR=$(mktemp -d)
          cp assembly/target/camunda-7-to-8-data-migrator-*.tar.gz "${ARTIFACT_DIR}/"
          cp assembly/target/camunda-7-to-8-data-migrator-*.zip "${ARTIFACT_DIR}/"
          echo "dir=${ARTIFACT_DIR}" >> $GITHUB_OUTPUT

      - name: Upload distro
        uses: actions/upload-artifact@v5
        if: github.ref == 'refs/heads/main'
        with:
          name: distro
          path: ${{ steps.distro.outputs.dir }}
          retention-days: 7

  postgresql:
    runs-on: ubuntu-latest
    timeout-minutes: 70
    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6

      - name: Import secrets
        id: secrets
        uses: hashicorp/vault-action@4c06c5ccf5c0761b6029f56cfb1dcf5565918a3b # v3.4.0
        with:
          url: ${{ secrets.VAULT_ADDR }}
          method: approle
          roleId: ${{ secrets.VAULT_ROLE_ID }}
          secretId: ${{ secrets.VAULT_SECRET_ID }}
          secrets: |
            secret/data/products/cambpm/ci/nexus NEXUS_APP_CAMUNDA_COM_USR;
            secret/data/products/cambpm/ci/nexus NEXUS_APP_CAMUNDA_COM_PSW;

      - name: Setup Maven
        uses: ./.github/actions/setup-maven
        with:
          vault-address: ${{ secrets.VAULT_ADDR }}
          vault-role-id: ${{ secrets.VAULT_ROLE_ID }}
          vault-secret-id: ${{ secrets.VAULT_SECRET_ID }}

      - name: Run tests with PostgreSQL
        run: mvn verify -Ppostgresql

  oracle:
    runs-on: ubuntu-latest
    timeout-minutes: 70
    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6

      - name: Import secrets
        id: secrets
        uses: hashicorp/vault-action@4c06c5ccf5c0761b6029f56cfb1dcf5565918a3b # v3.4.0
        with:
          url: ${{ secrets.VAULT_ADDR }}
          method: approle
          roleId: ${{ secrets.VAULT_ROLE_ID }}
          secretId: ${{ secrets.VAULT_SECRET_ID }}
          secrets: |
            secret/data/products/cambpm/ci/nexus NEXUS_APP_CAMUNDA_COM_USR;
            secret/data/products/cambpm/ci/nexus NEXUS_APP_CAMUNDA_COM_PSW;

      - name: Setup Maven
        uses: ./.github/actions/setup-maven
        with:
          vault-address: ${{ secrets.VAULT_ADDR }}
          vault-role-id: ${{ secrets.VAULT_ROLE_ID }}
          vault-secret-id: ${{ secrets.VAULT_SECRET_ID }}

      - name: Run tests with Oracle
        run: mvn verify -Poracle

  windows-h2:
    runs-on: windows-latest
    timeout-minutes: 70
    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6

      - name: Import secrets
        id: secrets
        uses: hashicorp/vault-action@4c06c5ccf5c0761b6029f56cfb1dcf5565918a3b # v3.4.0
        with:
          url: ${{ secrets.VAULT_ADDR }}
          method: approle
          roleId: ${{ secrets.VAULT_ROLE_ID }}
          secretId: ${{ secrets.VAULT_SECRET_ID }}
          secrets: |
            secret/data/products/cambpm/ci/nexus NEXUS_APP_CAMUNDA_COM_USR;
            secret/data/products/cambpm/ci/nexus NEXUS_APP_CAMUNDA_COM_PSW;

      - name: Setup Maven
        uses: ./.github/actions/setup-maven
        with:
          vault-address: ${{ secrets.VAULT_ADDR }}
          vault-role-id: ${{ secrets.VAULT_ROLE_ID }}
          vault-secret-id: ${{ secrets.VAULT_SECRET_ID }}

      - name: Build and run default tests
        run: mvn clean install -Pwindows --batch-mode

  e2e-cockpit-plugin:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6
        with:
          fetch-depth: 0
      
      - name: Check for relevant changes
        id: changes
        run: |
          # Check if we should run this job
          # Always run on main branch, schedule, or workflow_dispatch
          if [[ "${{ github.ref }}" == "refs/heads/main" ]] || \
             [[ "${{ github.event_name }}" == "schedule" ]] || \
             [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "Running on main/schedule/manual trigger"
            exit 0
          fi
          
          # For PRs, check if relevant files changed
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            changed_files=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
          else
            # For push events, compare with previous commit
            changed_files=$(git diff --name-only HEAD~1 HEAD)
          fi
          
          echo "Changed files:"
          echo "$changed_files"
          
          # Check if changes are in cockpit plugin or e2e tests
          if echo "$changed_files" | grep -qE '^(plugins/cockpit|qa/e2e-tests)/'; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "Relevant changes detected"
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "No relevant changes - skipping E2E tests"
          fi

      - name: Import secrets
        id: secrets
        if: steps.changes.outputs.should_run == 'true'
        uses: hashicorp/vault-action@4c06c5ccf5c0761b6029f56cfb1dcf5565918a3b # v3.4.0
        with:
          url: ${{ secrets.VAULT_ADDR }}
          method: approle
          roleId: ${{ secrets.VAULT_ROLE_ID }}
          secretId: ${{ secrets.VAULT_SECRET_ID }}
          secrets: |
            secret/data/products/cambpm/ci/nexus NEXUS_APP_CAMUNDA_COM_USR;
            secret/data/products/cambpm/ci/nexus NEXUS_APP_CAMUNDA_COM_PSW;

      - name: Setup Maven
        if: steps.changes.outputs.should_run == 'true'
        uses: ./.github/actions/setup-maven
        with:
          vault-address: ${{ secrets.VAULT_ADDR }}
          vault-role-id: ${{ secrets.VAULT_ROLE_ID }}
          vault-secret-id: ${{ secrets.VAULT_SECRET_ID }}

      - name: Build Cockpit Plugin
        if: steps.changes.outputs.should_run == 'true'
        run: mvn clean install -DskipTests -pl plugins/cockpit -am --batch-mode

      - name: Setup Node.js
        if: steps.changes.outputs.should_run == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: qa/e2e-tests/package-lock.json

      - name: Install E2E test dependencies
        if: steps.changes.outputs.should_run == 'true'
        working-directory: qa/e2e-tests
        run: npm ci

      - name: Install Playwright browsers
        if: steps.changes.outputs.should_run == 'true'
        working-directory: qa/e2e-tests
        run: npx playwright install --with-deps chromium

      - name: Run E2E tests
        if: steps.changes.outputs.should_run == 'true'
        working-directory: qa/e2e-tests
        run: npm test:with-data
        env:
          CI: true

      - name: Upload test results
        uses: actions/upload-artifact@v5
        if: steps.changes.outputs.should_run == 'true' && always()
        with:
          name: playwright-report
          path: qa/e2e-tests/playwright-report/
          retention-days: 7

      - name: Upload screenshots
        uses: actions/upload-artifact@v5
        if: steps.changes.outputs.should_run == 'true' && always()
        with:
          name: e2e-screenshots
          path: qa/e2e-tests/test-results/
          retention-days: 7

      - name: Upload Cockpit Plugin JAR
        uses: actions/upload-artifact@v5
        if: steps.changes.outputs.should_run == 'true' && always()
        with:
          name: data-migrator-cockpit-plugin
          path: plugins/cockpit/target/camunda-7-to-8-data-migrator-cockpit-plugin-0.2.0-SNAPSHOT.jar
          retention-days: 7

  # Rerun failed jobs running on self-hosted runners in case of network issues or node preemption
  rerun-failed-jobs:
    needs:
      - distro-h2
      - postgresql
      - oracle
      - windows-h2
      - e2e-cockpit-plugin
    if: failure() && fromJSON(github.run_attempt) < 3
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Retrigger job
        uses: camunda/infra-global-github-actions/rerun-failed-run@main
        with:
          error-messages: |
            The runner has received a shutdown signal
            Could not transfer artifact
            ContainerFetchException: Can't get Docker image: RemoteDockerImage
          run-id: ${{ github.run_id }}
          repository: ${{ github.repository }}
          vault-addr: ${{ secrets.VAULT_ADDR }}
          vault-role-id: ${{ secrets.VAULT_ROLE_ID }}
          vault-secret-id: ${{ secrets.VAULT_SECRET_ID }}
